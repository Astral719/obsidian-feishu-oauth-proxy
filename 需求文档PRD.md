# 产品需求文档：Obsidian 快捷分享到飞书插件 - V1.0

## 1. 修订历史
| 版本号 | 修订日期   | 修订人 | 修订内容 |
| ------ | ---------- | ------ | -------- |
| V0.1   | YYYY-MM-DD | (AI)   | 初稿创建：根据用户初步需求生成框架 |
| V0.2   | YYYY-MM-DD | (AI)   | 详细需求梳理与确认 |
| V1.0   | YYYY-MM-DD | (AI)   | 根据用户反馈优化文件夹选择交互、明确权限推断及错误处理方式。确认以此版本为V1.0进行开发。 |

## 2. 项目背景与目标
### 2.1 核心问题
用户在 Obsidian 中完成内容创作后，需要一种便捷的方式将 Markdown 内容快速分享到飞书生态中，以便于团队协作、信息同步或进一步传播。当前手动复制粘贴或导出再导入的方式效率较低，且可能存在格式兼容性问题。

### 2.2 需求目标
1.  **提升效率**: 提供一键式的操作，将 Obsidian 中的 Markdown 内容快速发布为飞书云文档。
2.  **优化体验**: 简化授权流程和分享操作，提供清晰的操作反馈，并尽可能优化配置体验（如文件夹选择）。
3.  **基本可用**: 确保核心的 Markdown 内容（文本和网络图片链接）能够正确转换为飞书云文档。

## 3. 用户画像与场景
### 3.1 目标用户
*   重度使用 Obsidian 进行笔记记录、知识管理和内容创作的用户。
*   同时使用飞书作为主要协作和信息分发平台的个人或团队成员。

### 3.2 用户场景
*   **场景一 (内容发布)**: 用户在 Obsidian 中撰写完一篇技术文章、会议纪要或产品方案后，希望快速将其发布到飞书，供团队成员查阅或讨论。
    *   **痛点**: 手动复制内容到飞书，图片链接可能需要调整，格式可能丢失。
    *   **期望**: 通过插件一键分享，自动在飞书生成格式正确的云文档，并能方便地选择存放位置。
*   **场景二 (个人归档与同步)**: 用户希望将 Obsidian 中的某些重要笔记备份或同步到自己的飞书空间，方便在不同设备或飞书环境中访问。
    *   **痛点**: 需要定期手动整理和上传，文件夹管理不便。
    *   **期望**: 可以快速选择笔记分享到飞书“我的空间”或通过交互界面选择的特定文件夹。

## 4. 功能需求详述
### 4.1 功能模块一：内容分享核心功能
#### 4.1.1 用户故事/功能点 1.1：通过菜单触发分享
*   **作为** Obsidian 用户
*   **我希望** 在当前打开的 Markdown 文件编辑界面的右上角菜单（通常由三个点图标引出）中看到一个“分享到飞书”的按钮
*   **以便于** 快速启动内容分享流程。
*   **业务规则与逻辑**:
    1.  当用户打开一个 Markdown 文件（`.md` 后缀）时，该按钮可见并可点击。
    2.  如果当前打开的不是 Markdown 文件，该按钮理想情况下不显示；如果技术实现上更容易做到按钮一直显示，则点击非 Markdown 文件时，应通过 Obsidian 通知提示“当前文件类型不支持分享到飞书”。
*   **验收标准**:
    1.  打开 Markdown 文件，右上角菜单中存在“分享到飞书”按钮。
    2.  点击按钮，能够触发后续的授权检查或分享流程。
    3.  打开非 Markdown 文件（如图片、PDF等），按钮不可见或点击后有明确提示。

#### 4.1.2 用户故事/功能点 1.2：Markdown 内容处理与上传
*   **作为** Obsidian 用户
*   **我希望** 点击“分享到飞书”后，插件能将当前 Markdown 文件的内容（包括文本和可公网访问的图片URL）发送给飞书
*   **以便于** 飞书能正确解析并生成一篇云文档。
*   **业务规则与逻辑**:
    1.  插件读取当前激活的 Markdown 文件的全部内容。
    2.  对于 Markdown 中的图片引用，仅处理通过标准 Markdown 语法 `![](图片URL)` 引入的、且图片 URL 是公网可访问的图片。本地图片（如 `![[image.png]]` 或 `![](assets/image.png)`) 不做特殊处理，即不上传图片文件本身，飞书侧将按其自身逻辑处理这些链接。
    3.  Obsidian 特有的 Markdown 语法（如双向链接 `[[wikilinks]]`、块引用 `^blockId`、标签 `#tag` 等）不做特殊转换，直接将原始 Markdown 文本传递给飞书，由飞书的 Markdown 导入功能自行处理。
    4.  文件名：上传到飞书的文档，其标题（文件名）直接使用 Obsidian 中当前 Markdown 文件的文件名（去除 `.md` 后缀）。
    5.  重复分享：每次用户对同一个或不同 Obsidian 文件执行“分享到飞书”操作，都在飞书创建一个新的、独立的云文档。不涉及更新已有飞书文档的逻辑。
*   **验收标准**:
    1.  分享成功后，在飞书创建的云文档内容与 Obsidian 中的 Markdown 源文件文本内容一致。
    2.  Markdown 中的标准网络图片链接在飞书文档中能够正常显示（前提是图片URL有效且飞书可访问）。
    3.  Obsidian 特有语法在飞书文档中的展现符合飞书 Markdown 导入的默认行为。
    4.  飞书文档的标题与 Obsidian 文件名一致。
    5.  多次分享同一个文件，会在飞书生成多个同名的新文档。

#### 4.1.3 用户故事/功能点 1.3：飞书文档存放位置
*   **作为** Obsidian 用户
*   **我希望** 分享的内容能默认存放到我的飞书“我的空间”，并且理想情况下能在插件设置中通过交互界面方便地选择一个常用的目标文件夹
*   **以便于** 管理我在飞书上生成的文档。
*   **业务规则与逻辑**:
    1.  **默认行为**: 如果用户未在插件设置中配置目标文件夹，或者配置的文件夹无效/未选择，则分享的文档默认创建在用户的飞书“我的空间”根目录下。
    2.  **配置目标文件夹 (V1.0 实现方式待定 - 见8.1)**:
        *   **理想交互 (若V1.0可实现)**:
            a.  在插件设置页面，用户授权飞书后，提供一个“选择默认文件夹”的按钮或区域。
            b.  点击后，插件通过飞书API获取用户云空间的文件夹列表（至少根目录及一级子文件夹，理想情况支持简单的文件夹层级导航或搜索）。
            c.  用户可以在此界面上直观地选择一个文件夹作为默认上传目标。
            d.  插件保存用户选定的文件夹ID (Folder Token)。
            e.  如果选择过程中出现错误（如无法加载文件夹列表），应有友好提示。
        *   **降级方案 (若理想交互V1.0不可行)**:
            *   **方案A (手动输入Folder Token)**: 用户在设置中手动输入目标文件夹的Folder Token。
            *   **方案B (V1.0不支持指定文件夹)**: 此功能在V1.0中不做，所有文档均上传至“我的空间”。
    3.  **上传逻辑 (基于最终采用的配置方式调整)**:
        a.  如果用户已成功配置了目标文件夹且该文件夹有效，则文档创建在该文件夹内。
        b.  如果用户未配置、配置的文件夹无效，或在交互选择时发生错误未能成功选定，插件应通过 Obsidian 通知提示用户具体的错误信息（如“目标文件夹无效，将上传到‘我的空间’”），然后自动尝试将文档创建在用户的飞书“我的空间”根目录下。
*   **验收标准**:
    1.  未配置目标文件夹时，文档成功创建在飞书“我的空间”根目录。
    2.  若V1.0实现了文件夹配置功能：成功配置目标文件夹后，文档成功创建在指定文件夹内。
    3.  若V1.0实现了文件夹配置功能：配置的目标文件夹后续无效时，能收到清晰的错误提示，并且文档最终成功创建在“我的空间”根目录。
    4.  若V1.0实现了交互式文件夹选择：交互式文件夹选择界面能正确加载和展示用户的文件夹（至少一级），并能成功保存用户的选择。

### 4.2 功能模块二：授权与设置
#### 4.2.1 用户故事/功能点 2.1：飞书账号授权
*   **作为** Obsidian 用户
*   **我希望** 首次使用分享功能或在插件设置中，能通过便捷的方式完成飞书账号的授权
*   **以便于** 插件有权限将内容上传到我的飞书空间。
*   **业务规则与逻辑**:
    1.  **触发授权**:
        a.  当用户首次点击“分享到飞书”按钮且未授权时，插件应引导用户进行授权。
        b.  用户也可以在插件设置页面主动发起授权或重新授权。
    2.  **授权方式**: 采用 OAuth 2.0 授权码模式。
        a.  插件提供一个按钮或链接，点击后跳转到飞书官方的授权页面。
        b.  用户在飞书页面登录并确认授权范围 (具体权限见8.2)。
        c.  授权成功后，飞书回调到插件预设的回调地址，插件获取授权码并用其换取 Access Token 和 Refresh Token。
        d.  插件需要安全地存储 Access Token 和 Refresh Token。Access Token 用于后续的 API 请求，Refresh Token 用于在 Access Token 失效时静默刷新。
    3.  **授权状态**: 插件设置页面应能显示当前的授权状态（例如：“已授权给 [飞书用户名/昵称]” 或 “未授权”）。
*   **验收标准**:
    1.  首次分享时，能正确引导用户跳转到飞书授权页。
    2.  用户在飞书完成授权后，插件能成功获取并存储 Token。
    3.  后续分享操作能自动使用已存储的 Token 进行，无需重复授权（除非 Token 失效且刷新失败）。
    4.  插件设置页能正确显示授权状态及用户昵称（如果获取到）。

#### 4.2.2 用户故事/功能点 2.2：插件设置界面
*   **作为** Obsidian 用户
*   **我希望** 插件提供一个设置界面
*   **以便于** 我管理飞书授权、配置默认上传文件夹等。
*   **业务规则与逻辑**:
    1.  **入口**: 在 Obsidian 的“第三方插件”管理区域，为本插件提供一个“设置”入口。
    2.  **设置项**:
        a.  **飞书授权管理**:
            *   显示当前授权状态（如：“已授权，账户：[用户飞书昵称]” 或 “未授权”）。
            *   提供“授权/重新授权”按钮：点击后启动 4.2.1 中描述的授权流程。
            *   提供“解除授权”按钮：点击后清除本地存储的 Token，并将授权状态更新为“未授权”，同时清除已选择的默认文件夹配置（如果已实现文件夹配置功能）。
        b.  **默认飞书目标文件夹配置 (具体交互依据8.1的V1.0决策)**:
            *   若实现交互选择：在用户授权后，此区域变为可操作。提供“选择文件夹”按钮，触发 4.1.3 中描述的文件夹选择逻辑。清晰显示当前已选定的默认文件夹名称或路径，如果未选择则提示“默认上传至‘我的空间’”。提供“清除选择”或“重置为默认（我的空间）”的选项。
            *   若实现手动输入：提供输入框让用户填写Folder Token，并保存。
            *   若V1.0不支持：此区域不显示或提示不支持。
*   **验收标准**:
    1.  插件设置界面可访问。
    2.  授权状态能正确显示。
    3.  “授权/重新授权”按钮功能符合预期。
    4.  “解除授权”按钮能清除授权信息（和文件夹配置，若有），之后分享会要求重新授权且（若无文件夹配置）默认上传到“我的空间”。
    5.  文件夹配置功能（如果V1.0实现）符合其对应的业务规则和验收标准。

### 4.3 功能模块三：用户反馈
#### 4.3.1 用户故事/功能点 3.1：操作结果反馈
*   **作为** Obsidian 用户
*   **我希望** 在执行分享操作后，能及时获得清晰的结果反馈（成功或失败）
*   **以便于** 我了解操作状态并进行下一步动作。
*   **业务规则与逻辑**:
    1.  **成功反馈**:
        a.  当内容成功上传到飞书并创建文档后，插件应通过 Obsidian 的系统通知 (Notice) 弹窗提示用户，例如：“分享成功！已创建飞书文档：[文档标题]”。
        b.  通知中应包含新创建的飞书云文档的链接。
        c.  提供一种便捷的方式复制该飞书文档链接（例如，通知中直接包含一个“复制链接”按钮，或者链接文本本身易于选中复制）。
    2.  **失败反馈**:
        a.  当分享操作因任何原因失败时，插件应通过 Obsidian 的系统通知 (Notice) 弹窗提示用户，例如：“分享失败！”。
        b.  通知中应尽可能清晰地展示错误原因。**插件应尝试解析飞书API返回的错误码：如果该错误码有已知的、插件内置的中文解释，则优先显示该解释，并附带原始错误码和错误信息；如果无内置解释，则直接显示原始错误码和从API获取的错误描述文本。**
        c.  所有错误信息（包括解释、错误码、原始信息）应支持复制，方便用户排查问题或向插件开发者反馈。
*   **验收标准**:
    1.  分享成功后，有成功的 Notice 提示，包含飞书文档标题和可访问/可复制的链接。
    2.  点击成功通知中的链接或复制后粘贴到浏览器，能打开对应的飞书文档。
    3.  分享失败时（模拟各种失败场景），有失败的 Notice 提示。
    4.  失败提示中，对于已知的飞书API错误码，能显示对应的中文解释；对于未知的，显示原始错误信息。所有错误信息均可复制。

## 5. 边界条件与约束
1.  **网络环境**: 用户设备需要能正常访问互联网以及飞书开放平台API。
2.  **飞书账号**: 用户必须拥有一个有效的飞书账号，并授权给本插件相应的权限。
3.  **Markdown 内容**: 仅处理文本和公网可访问的图片 URL。不负责本地图片的上传和转换。Obsidian 特定语法的渲染效果取决于飞书的 Markdown 解析能力。
4.  **API 限制**: 需遵守飞书开放平台的 API 调用频率限制和配额。
5.  **安全性**: 用户的 Access Token 和 Refresh Token 必须安全存储。
6.  **文件名限制**: 飞书对文件名/文档标题可能有长度或特殊字符限制。

## 6. 非功能性需求
*   **易用性**: 授权流程简单直接，分享操作一键完成，反馈信息清晰易懂，文件夹选择（若实现）直观方便。
*   **性能**: 点击分享按钮后响应及时，普通大小文件上传在数秒内完成。
*   **稳定性**: 插件稳定，授权失效有明确提示和引导。
*   **兼容性**: 兼容最新版本的 Obsidian。

## 7. 数据指标 (可选，用于衡量效果)
*   插件安装量/日活用户数。
*   平均每日通过插件分享的文档数量。
*   用户对分享效率提升的满意度。

## 8. 待讨论/待明确事项 (V1.0 开发前需决策或明确)
1.  **V1.0 文件夹选择交互的实现方式与范围 (需产品/开发决策)**:
    *   **理想方案**: 在插件设置中实现交互式选择飞书文件夹（如4.1.3所述）。
    *   **降级方案A (手动输入Folder Token)**: 允许用户手动输入目标文件夹的 Folder Token。
    *   **降级方案B (V1.0不支持指定文件夹)**: 所有分享内容统一上传到用户的飞书“我的空间”根目录。
    *   **决策依据**: V1.0 开发资源、周期及技术复杂度。
2.  **飞书 API 权限范围 (初步推断，需开发时最终确认)**:
    *   **基础授权与用户信息**:
        *   `contact:user.base:readonly` (读取用户基本信息，如昵称，用于设置界面显示)。
    *   **文档创建**:
        *   `docs:doc:create` (创建新版飞书文档)。
    *   **文件夹操作 (若V1.0实现文件夹选择功能)**:
        *   `drive:explorer:readonly` 或 `drive:folder:list_children` (获取文件夹列表)。
        *   `docs:doc:create_in_folder` (在指定文件夹创建文档)。
    *   **注意**: 遵循最小权限原则。具体以飞书开放平台最新API文档和实际对接为准。
3.  **获取 Folder Token 的引导 (若降级为手动输入)**: 如果V1.0采用手动输入Folder Token的方案，需在插件设置中提供清晰简明的图文引导。
4.  **错误代码本地化映射表**: 收集常见的飞书API错误代码及其对应的中文解释，内置于插件中。V1.0可先覆盖最常见的几种（如token失效、权限不足、参数错误、找不到文件夹等）。

