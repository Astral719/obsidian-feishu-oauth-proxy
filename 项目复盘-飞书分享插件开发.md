# 飞书分享插件开发项目复盘

## 1. 项目概述 (Project Overview)

**项目名称:** 飞书分享 (Feishu Share) - Obsidian 插件
**项目目标:** 开发一个能够将 Obsidian Markdown 文档一键分享到飞书云文档的插件
**开发周期:** 2025-06-23 至 2025-06-27 (5天，实际有效开发时间约12小时)
**最终状态:** ✅ 成功提交到 Obsidian 官方插件市场，通过所有自动化检查，进入人工审核阶段

### 核心功能实现
- ✅ OAuth 2.0 自动授权流程
- ✅ Markdown 文件上传到飞书
- ✅ MD 转 DOCX 在线文档转换
- ✅ 智能文件夹选择
- ✅ 一键复制分享链接
- ✅ Obsidian 语法处理（双向链接、标签等）

## 2. 技术架构演进历程 (Technical Architecture Evolution)

### 阶段一：探索与需求分析 (2025-06-23)
**初始想法:** 基于已有的 Python 代理服务器改进
**技术调研:**
- 研究 Obsidian 插件开发基础
- 分析飞书 API 文档和认证流程
- 评估现有 md2feishu 项目的可扩展性

### 阶段二：Python 代理服务器方案 (2025-06-23 - 2025-06-25)
**技术栈:** Python Flask + Vercel 部署
**架构特点:**
- Obsidian 插件 → Python 代理服务器 → 飞书 API
- 代理服务器处理 OAuth 和文件转换
- 插件只负责发送文件内容

**开发过程:**
- 完善了 Python 后端的 OAuth 流程
- 实现了文件上传和转换功能
- 部署到 Vercel 并配置域名

**遇到的问题:**
- CORS 跨域问题反复出现
- 代理服务器稳定性问题
- 用户需要依赖外部服务，体验不佳

### 阶段三：混合方案尝试 (2025-06-26 上午)
**尝试方向:** Obsidian 插件 + 简化的云端回调
**技术特点:**
- 插件处理大部分逻辑
- 云端只负责 OAuth 回调中转
- 尝试解决 CORS 问题

**失败原因:**
- CORS 问题依然存在
- 架构复杂度没有显著降低
- 调试困难，错误定位不准确

### 阶段四：直接 API 调用方案 (2025-06-26 下午 - 2025-06-27)
**技术栈:** TypeScript + Obsidian API + 飞书 Open API
**架构特点:**
- Obsidian 插件直接调用飞书 API
- 内置 OAuth 2.0 授权流程
- 本地处理 Markdown 语法转换

**成功关键因素:**
- 发现 Obsidian 的 `requestUrl` API 可以避免 CORS 问题
- 实现完整的 OAuth 2.0 流程
- 采用渐进式重试机制处理异步转换
- 优雅的错误处理和用户反馈

## 3. 详细里程碑时间线 - 每一次岔路的完整记录
*基于实际对话记录，包含所有错误决策和纠正过程*

### 2025-06-23 (项目启动 - 约2小时有效时间)
**对话时段:** 初次讨论和需求分析

#### 🎯 正确决策
- **09:00-10:00** 明确项目目标：开发 Obsidian 插件分享到飞书
- **10:00-11:00** 分析现有 md2feishu 项目的可扩展性

#### ⚠️ 第一个岔路：架构选择
- **11:00-11:30** **错误决策：** 过度依赖现有 Python 项目
  - **决策逻辑：** "既然 Python 后端已经工作，就基于它扩展"
  - **隐藏风险：** 没有充分评估 Obsidian 插件的原生能力
  - **后果预览：** 为后续的 CORS 问题埋下伏笔

- **关键决策:** 决定基于 Python 后端 + Obsidian 插件的架构
- **当时的合理性：** 基于已有资产，看似高效
- **后来的问题：** 架构复杂度过高，引入不必要的网络依赖

### 2025-06-24 (后端优化 - 约1.5小时有效时间)
**对话时段:** Python 后端功能完善

#### 🎯 正确执行
- **13:00-14:00** 优化 OAuth 授权流程，提升稳定性
- **14:00-14:30** 完善文件上传和转换逻辑

#### ⚠️ 第二个岔路：过度投入沉没成本
- **14:30-15:00** **错误决策：** 继续完善 Python 后端细节
  - **决策逻辑：** "既然选择了这个方案，就要做到最好"
  - **沉没成本谬误：** 投入越多，越难放弃
  - **机会成本：** 没有探索 Obsidian 插件的原生 API 能力

- **技术成果：** 部署到 https://md2feishu.xinqi.life，功能完整
- **隐藏问题：** 为复杂架构投入了更多精力，增加了后续重构的心理阻力

### 2025-06-25 (插件开发 - 约2小时有效时间)
**对话时段:** Obsidian 插件基础实现

#### 🎯 正确进展
- **09:00-10:00** 创建插件基础框架，学习 Obsidian API
- **10:00-10:30** 实现基本的 UI 界面和设置管理

#### ⚠️ 第三个岔路：CORS 问题的初现
- **10:30-11:00** **问题发现：** 插件无法直接调用外部 API
  - **初始反应：** "这只是一个小的技术问题"
  - **错误假设：** "CORS 问题总是可以通过设置 headers 解决"
  - **忽略的信号：** 浏览器环境的根本性限制

- **11:00-11:30** **错误尝试：** 各种 CORS 绕过方案
  - **尝试方向：** 修改请求头、使用代理、JSONP 等
  - **根本问题：** 没有深入理解 Obsidian 插件的运行环境
  - **时间浪费：** 在错误的方向上消耗精力

### 2025-06-26 (重大转折 - 约4小时有效时间)

#### 上午时段 (1.5小时)：CORS 黑洞期 🕳️
**09:00-09:30** **岔路加深：** 固执的问题解决思维
- **错误心态：** "我一定能解决这个 CORS 问题"
- **技术盲区：** 不了解 Obsidian 插件的网络请求机制
- **情绪影响：** 挫败感开始影响判断力

**09:30-10:00** **第四个岔路：试错式调试**
- **错误方法：** 随机尝试各种 CORS 解决方案
- **缺乏系统性：** 没有建立问题分析框架
- **信息不足：** 没有深入研究 Obsidian 插件文档

**10:00-10:30** **情绪低谷：** "还是有两个问题"
- **挫败感累积：** 多次尝试失败，开始质疑技术能力
- **沉没成本压力：** 已投入大量时间，不愿承认方向错误
- **认知负荷过高：** 同时处理多个技术问题，思维混乱

#### 下午时段 (2.5小时)：突破与重构 🚀
**13:00-13:30** **关键转折：** 架构反思时刻
- **心态转变：** 从"修复问题"到"重新思考"
- **关键问题：** "是否存在不需要 CORS 的方案？"
- **突破性思维：** 开始质疑架构的根本合理性

**13:30-14:00** **第五个岔路：是否重构的决策**
- **内心斗争：** 重构 vs 继续修复
- **沉没成本考量：** 已有的 Python 后端投入
- **正确决策：** 果断选择重构，及时止损

**14:00-14:30** **技术突破：** 发现 `requestUrl` API
- **关键发现：** Obsidian 提供了绕过 CORS 的原生 API
- **"啊哈"时刻：** 意识到可以完全抛弃代理服务器
- **架构重构：** 决定转向纯插件方案

**14:30-16:00** **快速实现期：** 重写核心逻辑
- **高效执行：** 技术路径清晰后的快速开发
- **OAuth 重写：** 在插件内实现完整的授权流程
- **API 集成：** 直接调用飞书 API，绕过所有网络问题

### 2025-06-27 (功能完善和发布 - 约2.5小时有效时间)

#### 凌晨时段 (1.5小时)：功能完善
**00:00-01:00** **核心功能实现**
- **文件上传：** 实现 MD 文件上传到飞书云盘
- **格式转换：** MD 转 DOCX 在线文档
- **状态轮询：** 异步转换状态监控

**01:00-01:30** **第六个岔路：轮询策略选择**
- **技术选择：** 2秒间隔 vs 更长间隔
- **正确决策：** 选择 2秒间隔，基于之前 Python 版本的成功经验
- **优化考虑：** 渐进式延迟策略，平衡性能和用户体验

#### 下午时段 (1小时)：发布流程
**16:00-16:15** **第一次发布尝试**
- **创建 Release 1.0.0**
- **提交到 obsidian-releases**
- **遇到自动化检查失败**

**16:15-16:30** **第七个岔路：检查失败的应对**
- **初始反应：** 困惑和轻微焦虑
- **错误假设：** "可能是临时的系统问题"
- **正确行动：** 深入分析失败原因

**16:30-16:45** **问题诊断：** 系统性排查
- **发现问题1：** manifest.json 包含 "Obsidian" 字样
- **发现问题2：** JavaScript 语法错误
- **发现问题3：** fundingUrl 指向错误仓库

**16:45-17:00** **第八个岔路：修复策略选择**
- **选择1：** 修复当前 Release
- **选择2：** 创建新版本 1.0.1
- **正确决策：** 创建新版本，避免版本混乱

**17:00-17:15** **最终成功**
- **重新构建：** 修复所有发现的问题
- **上传文件：** 确保所有必需文件完整
- **PR 模板：** 使用官方标准模板
- **检查通过：** 所有自动化检查成功

### 岔路总结与教训

#### 主要岔路分析
1. **架构选择岔路** (6.23) - 路径依赖，未充分评估替代方案
2. **沉没成本岔路** (6.24) - 过度投入错误方向
3. **CORS 问题岔路** (6.25) - 技术盲区，缺乏系统性分析
4. **试错调试岔路** (6.26上午) - 方法论错误，情绪影响判断
5. **重构决策岔路** (6.26下午) - 正确的及时止损
6. **轮询策略岔路** (6.27凌晨) - 基于经验的正确选择
7. **检查失败岔路** (6.27下午) - 系统性问题解决
8. **修复策略岔路** (6.27下午) - 版本管理的正确决策

#### 岔路类型分类
- **技术认知岔路：** 对技术边界的误判 (CORS问题)
- **决策心理岔路：** 沉没成本和路径依赖 (架构选择)
- **方法论岔路：** 试错 vs 系统分析 (调试方法)
- **情绪管理岔路：** 挫败感影响理性判断 (CORS黑洞期)

#### 走出岔路的关键因素
1. **及时反思：** 定期质疑当前方向的合理性
2. **止损决策：** 承认错误，果断调整方向
3. **系统思维：** 从根本原因而非表面现象分析问题
4. **情绪管理：** 保持理性，避免情绪化决策

## 3.1 实际有效开发时间统计

### 按日期分布
- **2025-06-23:** 2小时 (需求分析和方案设计)
- **2025-06-24:** 1.5小时 (Python 后端优化)
- **2025-06-25:** 2小时 (插件基础开发)
- **2025-06-26:** 4小时 (架构重构和核心实现)
- **2025-06-27:** 2.5小时 (功能完善和发布)

**总计:** 12小时有效开发时间

### 按阶段分布
- **需求分析和技术调研:** 1.5小时 (12.5%)
- **Python 后端开发:** 1.5小时 (12.5%) - 最终废弃
- **插件基础框架:** 1小时 (8.3%)
- **CORS 问题调试:** 1.5小时 (12.5%)
- **架构重构:** 1小时 (8.3%)
- **核心功能实现:** 3小时 (25%)
- **UI 和用户体验:** 1小时 (8.3%)
- **测试和优化:** 0.5小时 (4.2%)
- **发布和问题修复:** 1小时 (8.3%)

## 4. 资源与时间投入分析 (Resource & Time Allocation Analysis)
*基于实际对话记录的精确时间统计*

### 总体时间投入
**项目总耗时:** 12小时 (5天内的有效对话时间)
**平均每日有效时间:** 2.4小时
**最高效单日:** 2025-06-26 (4小时，包含重大架构转折)

### 高效时间段分析
1. **2025-06-26 下午-晚上** (2.5小时) - 架构重构和核心实现
2. **2025-06-27 凌晨** (1.5小时) - 功能完善
3. **2025-06-26 上午** (1.5小时) - CORS 问题深度分析

### 按功能模块的精确时间分配
- **需求分析和技术调研:** 1.5小时 (12.5%)
- **Python 后端开发:** 1.5小时 (12.5%) - **浪费时间**
- **插件基础框架:** 1小时 (8.3%)
- **CORS 问题调试:** 1.5小时 (12.5%) - **低效时间**
- **架构重构决策:** 1小时 (8.3%)
- **OAuth 授权流程:** 1.5小时 (12.5%)
- **文件上传和转换:** 1.5小时 (12.5%)
- **UI 和用户体验:** 1小时 (8.3%)
- **测试和优化:** 0.5小时 (4.2%)
- **发布和问题修复:** 1小时 (8.3%)

### 效率分析

#### 高效时间段 (6小时，50%)
- **核心功能实现:** 3小时 - 产出最大价值
- **架构重构:** 1小时 - 关键决策时刻
- **需求分析:** 1.5小时 - 为后续开发奠定基础
- **发布成功:** 0.5小时 - 最终交付

#### 低效时间段 (3小时，25%)
- **Python 后端开发:** 1.5小时 - 完全浪费
- **CORS 问题调试:** 1.5小时 - 反复试错，效率低

#### 必要但复杂的时间 (3小时，25%)
- **OAuth 授权流程:** 1.5小时 - 复杂但必需
- **插件基础框架:** 1小时 - 学习成本
- **测试和优化:** 0.5小时 - 质量保证

### 时间效率关键指标

#### 代码产出效率
- **有效代码行数:** 约1750行 (main.js)
- **代码产出速度:** 145行/小时 (基于12小时)
- **功能完成度:** 100% (所有预期功能均实现)

#### 问题解决效率
- **重大技术问题:** 2个 (CORS + OAuth)
- **平均解决时间:** 1.5小时/问题
- **一次性解决率:** 50% (OAuth一次成功，CORS需要架构调整)

#### 学习转化效率
- **新技术学习:** Obsidian API + 飞书 API
- **学习时间:** 2小时
- **应用成功率:** 100% (学到的知识都得到应用)

### 根本原因分析

#### 浪费时间根因: Python 后端开发 (1.5小时)
**根本原因:**
- **路径依赖:** 过度依赖已有的 Python 项目经验
- **技术调研不足:** 没有充分评估 Obsidian 插件的原生能力
- **决策过早:** 在没有验证 CORS 可行性前就投入开发

#### 低效时间根因: CORS 调试 (1.5小时)
**根本原因:**
- **思维固化:** 被传统 Web 开发的 CORS 概念束缚
- **文档研读不够:** 没有及时查阅 Obsidian 插件 API 文档
- **试错方法单一:** 缺乏系统性的问题分析框架

#### 高效时间成功因素
**关键成功要素:**
- **目标明确:** 每个时间段都有清晰的目标
- **技术突破:** 发现 `requestUrl` API 是转折点
- **迭代快速:** 小步快跑，快速验证和调整

## 5. 挑战与障碍分析 (Analysis of Challenges & Blockers)

### 技术挑战

#### 挑战1: CORS 跨域问题
**问题描述:** 浏览器环境下直接调用飞书 API 遇到 CORS 限制  
**解决过程:** 
1. 尝试设置各种 CORS 头部 - 失败
2. 考虑使用代理服务器 - 增加复杂性
3. 发现 Obsidian 的 `requestUrl` API 可以绕过 CORS - 成功

**影响:** 导致架构重构，额外消耗4小时

#### 挑战2: OAuth 回调处理
**问题描述:** Obsidian 插件无法直接接收 HTTP 回调  
**解决过程:**
1. 研究 Obsidian 协议处理器
2. 实现自定义协议 `obsidian://feishu-auth`
3. 配合云端回调页面实现自动跳转

**影响:** 增加了授权流程的复杂性，但提升了用户体验

#### 挑战3: 异步文件转换
**问题描述:** 飞书文件转换是异步的，需要轮询状态  
**解决过程:**
1. 实现渐进式延迟轮询 (1s → 2s → 3s)
2. 设置15秒超时机制
3. 失败时回退到原始文件链接

**影响:** 需要精细的状态管理和错误处理

### 流程挑战

#### 挑战1: Obsidian 插件市场规范
**问题描述:** 不熟悉官方插件提交要求  
**解决过程:**
1. 仔细阅读官方文档和 PR 模板
2. 修复 manifest.json 中的 "Obsidian" 字样
3. 确保文件结构符合要求

**影响:** 延迟发布30分钟，但避免了审核被拒

## 6. 经验与教训总结 (Lessons Learned)

### 失败教训 (What Went Wrong & Why)

#### 决策失误1: 过早选择代理方案
**错误决策:** 在没有充分调研 Obsidian API 能力的情况下，选择了复杂的代理服务器方案  
**当时依据:** 认为浏览器环境无法直接调用第三方 API  
**错误原因:** 对 Obsidian 插件 API 了解不够深入  
**本可避免:** 如果提前阅读 Obsidian 插件开发文档，了解 `requestUrl` API 的存在

#### 执行偏差1: 调试方法低效
**问题:** 在 OAuth 调试过程中，过度依赖 console.log，缺乏系统性的调试策略  
**改进:** 应该建立结构化的日志系统，分层记录关键信息

### 成功心得 (What Went Right & Why)

#### 有效策略1: 渐进式开发
**成功做法:** 先实现核心功能，再逐步完善 UI 和错误处理  
**效果:** 快速验证可行性，避免在错误方向上投入过多时间

#### 关键突破1: 发现 requestUrl API
**"啊哈"时刻:** 在阅读 Obsidian 插件示例代码时，发现了 `requestUrl` API  
**突破原因:** 
- 系统性地阅读了官方文档和示例
- 没有固化在"浏览器限制"的思维中
- 主动寻找替代方案

#### 有效策略2: 错误处理优先
**成功做法:** 在每个关键功能点都实现了完善的错误处理和用户反馈  
**效果:** 提升了用户体验，减少了调试难度

## 7. 最佳实践与行动建议 (Best Practices & Actionable Recommendations)

### 实践1 (关于技术选型)
**原则:** 在投入大规模编码前，必须针对核心、不确定的技术点进行"最小可行性验证（PoC）"，以不超过4小时的时间盒验证方案的可行性，避免路线错误。

**具体行动:**
- 列出项目中的3-5个技术不确定点
- 为每个不确定点创建独立的 PoC
- 设置明确的成功/失败标准

### 实践2 (关于 API 集成)
**原则:** 对于第三方 API 集成，优先采用"官方文档 + 实际测试"的双重验证法，不依赖二手资料或假设。

**具体行动:**
- 使用 Postman 等工具先验证 API 调用
- 记录每个 API 的实际响应格式
- 建立 API 调用的标准错误处理模式

### 实践3 (关于调试)
**原则:** 针对复杂问题，优先采用"结构化日志 + 状态追踪"的调试法，而非依赖断点单步跟踪。

**具体行动:**
- 在关键逻辑路径上添加带时间戳的详细日志
- 使用统一的日志格式：`[时间] [模块] [级别] 具体信息`
- 建立日志分析的标准流程

### 实践4 (关于发布)
**原则:** 在开发阶段后期，提前完整阅读并理解目标平台的《发布指南》和《审核政策》，并创建一个"发布检查清单（Release Checklist）"。

**具体行动:**
- 在开发50%完成时就开始研究发布要求
- 创建包含所有检查项的清单
- 在本地环境模拟发布流程

### 实践5 (关于用户体验)
**原则:** 对于涉及外部服务的功能，必须实现"优雅降级"机制，确保在最坏情况下用户仍能获得基本功能。

**具体行动:**
- 为每个外部依赖设计备选方案
- 实现超时和重试机制
- 提供清晰的错误信息和解决建议

## 8. 项目成果与影响 (Project Outcomes & Impact)

### 技术成果
- ✅ 成功开发了功能完整的 Obsidian 插件
- ✅ 实现了复杂的 OAuth 2.0 授权流程
- ✅ 建立了可复用的飞书 API 集成模式

### 学习收获
- 深入理解了 Obsidian 插件开发生态
- 掌握了飞书开放平台 API 的使用
- 积累了跨平台集成的实战经验

### 未来改进方向
- 支持批量文件分享
- 增加更多文档格式支持
- 优化大文件处理性能

---

## 9. 项目数据总结 (Project Metrics Summary)

### 开发效率指标
- **总开发时间:** 12小时 (有效对话时间)
- **代码产出:** 1,750行 TypeScript/JavaScript
- **功能模块:** 8个主要模块 (OAuth、文件上传、转换、UI等)
- **Bug修复:** 3个主要问题 (CORS、manifest、语法错误)
- **发布成功率:** 100% (第二次提交通过所有检查)

### 技术债务分析
- **废弃代码:** Python 后端 (~500行) - 1.5小时投入
- **重构代码:** 插件架构完全重写 - 1小时投入
- **优化空间:** 错误处理和用户体验还可进一步完善

### 学习成果量化
- **新API掌握:** Obsidian Plugin API + 飞书 Open API
- **新技术栈:** TypeScript 插件开发
- **架构模式:** OAuth 2.0 + 异步文件处理
- **发布流程:** GitHub Release + 社区插件提交

---

**复盘完成时间:** 2025-06-27
**复盘基于:** 完整对话记录和实际开发时间
**有效开发时间:** 12小时 (5天内)
**下次复盘计划:** 插件正式上架后进行用户反馈复盘
